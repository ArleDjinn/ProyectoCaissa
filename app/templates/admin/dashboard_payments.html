{# templates/admin/dashboard_payments.html #}
{% extends "admin/dashboard_base.html" %}

{% block dashboard_content %}
<h2 class="mb-4">游눱 Pagos y Estado de Inscripci칩n</h2>

<!-- Nuevos ni침os desde 칰ltimo login -->
<div class="card mb-4">
    <div class="card-header">
        Nuevos ni침os desde tu 칰ltimo login
    </div>
    <div class="card-body">
        {% if new_children %}
            <p>Se han inscrito <strong>{{ new_children|length }}</strong> ni침o(s) desde {{ last_login.strftime('%d-%m-%Y %H:%M') }}:</p>
            <ul class="list-inline mb-0">
                {% for c in new_children %}
                    <li class="list-inline-item">
                        {{ c.name }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted mb-0">No hay nuevos ni침os desde tu 칰ltimo acceso.</p>
        {% endif %}
    </div>
</div>

<!-- Suscripciones que necesitan reemitir orden -->
<div class="card mb-4">
    <div class="card-header">
        Renovaci칩n de 칩rdenes de pago
    </div>
    <div class="card-body p-0">
        {% if subscriptions_due %}
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead class="table-dark">
                    <tr>
                        <th>Apoderado</th>
                        <th>Plan</th>
                        <th>칔ltima orden</th>
                        <th>Pr칩xima emisi칩n</th>
                        <th class="text-center">Monto</th>
                        <th class="text-center">Acci칩n</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in subscriptions_due %}
                        <tr>
                            <td>
                                {{ item.subscription.guardian.user.name }}<br>
                                <small class="text-muted">{{ item.subscription.guardian.user.email }}</small>
                            </td>
                            <td>
                                {{ item.subscription.plan.name }}<br>
                                <small class="text-muted">{{ item.subscription.billing_cycle.value }}</small>
                            </td>
                            <td>
                                {% if item.last_order %}
                                    #{{ item.last_order.id }} 췅 {{ item.last_order.payment_status.value }}<br>
                                    <small class="text-muted">Emitida el {{ item.last_order.created_at.strftime('%d-%m-%Y') }}</small><br>
                                    <small class="text-muted">M칠todo sugerido: {{ item.recommended_method.value }}</small>
                                {% else %}
                                    <span class="text-muted">Sin 칩rdenes registradas</span><br>
                                    <small class="text-muted">M칠todo sugerido: {{ item.recommended_method.value }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.days_overdue > 0 %}
                                    <span class="text-danger fw-semibold">Vencida hace {{ item.days_overdue }} d칤a{% if item.days_overdue != 1 %}s{% endif %}</span><br>
                                {% else %}
                                    <span class="text-warning fw-semibold">Emitir hoy</span><br>
                                {% endif %}
                                <small class="text-muted">{{ item.reason }}</small><br>
                                <small class="text-muted">Pr칩xima fecha: {{ item.due_date.strftime('%d-%m-%Y') }}</small>
                            </td>
                            <td class="text-center">
                                ${{ "{:,}".format(item.amount_clp).replace(",", ".") }} CLP
                            </td>
                            <td class="text-center">
                                <form action="{{ url_for('admin.issue_subscription_order', subscription_id=item.subscription.id) }}" method="post">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button class="btn btn-primary btn-sm">Emitir orden</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted m-3">Todas las suscripciones activas est치n al d칤a.</p>
        {% endif %}
    </div>
</div>

<!-- Tabla de 칩rdenes pendientes -->
<div class="card">
    <div class="card-header">
        칍rdenes de pago pendientes
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-dark">
                <tr>
                    <th>Apoderado</th>
                    <th>Ni침os</th>
                    <th>Plan</th>
                    <th class="text-center">Talleres</th>
                    <th class="text-center">Monto</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center">Pago</th>
                    <th class="text-center">Restablecer contrase침a</th>
                </tr>
                </thead>
        <tbody>
          {% for order in pending_orders %}
            <tr>
              <td>
                {{ order.subscription.guardian.user.name }}<br>
                <small class="text-muted">{{ order.subscription.guardian.user.email }}</small><br>
                <small class="text-muted">游 {{ order.subscription.guardian.phone }}</small>
              </td>
              <td>
                {% for c in order.subscription.guardian.children %}
                  {{ c.name }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              </td>
              <td>{{ order.subscription.plan.name }}</td>
              <td class="text-center">
                  {% for e in order.subscription.enrollments if e.status.name == 'active' %}
                      <div class="d-inline-block border rounded px-2 py-1 m-1" style="min-width: 120px; text-align: center;">
                          <strong>{{ e.workshop.name }}</strong><br>
                          <small>{{ e.workshop.day_of_week.value }} {{ e.workshop.start_time.strftime('%H:%M') }}</small>
                      </div>
                  {% endfor %}
              </td>
              <td>${{ "{:,}".format(order.amount_clp) }} {{ order.currency }}</td>
              <td>{{ order.payment_status.value }}</td> <!--<span class="badge text-bg-warning">{{ order.payment_status.value }}</span>-->
              <td class="text-center">
                  {% if order.payment_method.name == 'webpay' %}
                      <small class="text-muted d-block mb-2">Coordina un pago alternativo (transferencia o presencial).</small>
                  {% endif %}
                  {% if current_user.is_authenticated and current_user.is_admin %}
                      <form action="{{ url_for('orders.confirm_payment', order_id=order.id) }}"
                            method="post" class="d-inline">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <button class="btn btn-success btn-sm">Confirmar</button>
                      </form>
                  {% endif %}
              </td>
                <td class="text-center">
                    <form action="{{ url_for('admin.trigger_password_reset', user_id=order.subscription.guardian.user.id) }}"
                          method="post" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-outline-secondary btn-sm" type="submit">Enviar enlace</button>
                    </form>
                    <small class="text-muted d-block mt-2">Caduca en {{ reset_expiration_hours }} {{ 'hora' if reset_expiration_hours == 1 else 'horas' }}.</small>
                </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                  No hay 칩rdenes pendientes de pago.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Tabla de 칩rdenes pagadas -->
<div class="card mt-4">
    <div class="card-header">
        칍rdenes pagadas
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-dark">
                <tr>
                    <th>Apoderado</th>
                    <th>Ni침os</th>
                    <th>Plan</th>
                    <th class="text-center">Talleres</th>
                    <th class="text-center">Monto</th>
                    <th class="text-center">M칠todo</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center">Restablecer contrase침a</th>
                    <th class="text-center">Acci칩n</th>
                </tr>
                </thead>
                <tbody>
                {% for order in paid_orders %}
                    <tr>
                        <td>
                            {{ order.subscription.guardian.user.name }}<br>
                            <small class="text-muted">{{ order.subscription.guardian.user.email }}</small><br>
                            <small class="text-muted">游 {{ order.subscription.guardian.phone }}</small>
                        </td>
                        <td>
                            {% for c in order.subscription.guardian.children %}
                                {{ c.name }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td>{{ order.subscription.plan.name }}</td>
                        <td class="text-center">
                            {% for e in order.subscription.enrollments if e.status.name == 'active' %}
                                <div class="d-inline-block border rounded px-2 py-1 m-1" style="min-width: 120px; text-align: center;">
                                    <strong>{{ e.workshop.name }}</strong><br>
                                    <small>{{ e.workshop.day_of_week.value }} {{ e.workshop.start_time.strftime('%H:%M') }}</small>
                                </div>
                            {% endfor %}
                        </td>
                        <td class="text-center">
                            ${{ "{:,}".format(order.amount_clp) }} {{ order.currency }}
                        </td>
                        <td class="text-center">{{ order.payment_method.value }}</td>
                        <td class="text-center">
                            <span class="badge bg-success">{{ order.payment_status.value }}</span>
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('admin.trigger_password_reset', user_id=order.subscription.guardian.user.id) }}"
                                  method="post" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button class="btn btn-outline-secondary btn-sm" type="submit">Enviar enlace</button>
                            </form>
                            <small class="text-muted d-block mt-2">Caduca en {{ reset_expiration_hours }} {{ 'hora' if reset_expiration_hours == 1 else 'horas' }}.</small>
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('orders.revert_payment', order_id=order.id) }}"
                                  method="post" class="d-inline"
                                  onsubmit="return confirm('Revertir el pago?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button class="btn btn-outline-warning btn-sm">Revertir</button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            No hay 칩rdenes pagadas registradas.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
